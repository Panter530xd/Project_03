import Head from "next/head";
import Image from "next/image";
import LogoBig from "../../public/images/Icons//logo-golemo.svg";
import CircleSmall from "../../public/images/background-images/krug-pogolem.svg";
import CircleBig from "../../public/images/background-images/krug-pomal.svg";
import Link from "next/link";
import { createServerSupabaseClient } from "@supabase/auth-helpers-nextjs";
import { GetServerSideProps } from "next";
import { Profiles } from "@/types/profiles";
import HetIcon from "../../public/images/Icons/hats.svg";
import HeartIcon from "../../public/images/Icons/heard.svg";
import TeaIcon from "../../public/images/Icons/tea.svg";
import CarbonUserIcon from "../../public/images/Icons/carbon.svg";
import IconTwo from "../../public/images/Icons/image41.svg";
import IconTree from "../../public/images/Icons/image42.svg";
import IconFour from "../../public/images/Icons/image43.svg";
import CardCooks from "@/components/card-profiles/CardCooks";
import SearchAddress from "@/components/search-address/SearchAddress";
interface Props {
  userProfiles: Profiles[];
  profilesAllData: Profiles[];
  filteredProfilesByQuery: [];
}

export default function Home({
  userProfiles,
  profilesAllData,
  filteredProfilesByQuery,
}: Props): JSX.Element {
  return (
    <>
      <Head>
        <title>Јади домашно</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <section className="xl:flex xl:justify-center items-center xl:pt-40 xl:pb-40 pb-10 pt-10 relative">
        <Image
          priority
          src="/images/background-images/foood2.png"
          alt="bg-image"
          className="absolute right-0 top-1 z-0 hidden lg:block"
          width={590}
          height={637}
        />
        <CircleSmall
          className="absolute right-0 top-[200px] z-0 hidden lg:block"
          priority
        />
        <CircleBig
          className="absolute right-0 top-[450px] z-0 hidden lg:block"
          priority
          width={90}
          height={333}
        />

        <div>
          <div className="flex justify-center items-center">
            <LogoBig width={105} height={112} />
            <h1 className="xl:text-6xl text-OrangeSecondary xl:font-outline ">
              Јади домашно
            </h1>
          </div>
          <div className="flex items-center justify-center pt-5">
            <hr className=" xl:w-32 w-16 border-2 border-OrangeSecondary" />
            <h2 className=" font-badscript xl:text-[40px] pl-2 pr-2">
              Вкусот на твоето соседство!
            </h2>
            <hr className=" xl:w-32 w-16 border-2 border-OrangeSecondary" />
          </div>
          <SearchAddress profilesAllData={profilesAllData} />
        </div>
        <div className="z-10">
          <Image
            priority
            src="/images/images-static/tavce gravce.png"
            width={713}
            height={675}
            alt="Tavce Gravce"
            className=" z-10"
          />
        </div>
        <Image
          src="/images/background-images/food3.png"
          className=" absolute top-[650px] left-0 hidden lg:block"
          alt="Food"
          width={390}
          height={437}
        />
      </section>
      <section className="xl:pt-20 xl:pb-20 pb-10 relative">
        <div className="flex items-center justify-center">
          <hr className=" xl:w-32 w-16 border-2 border-OrangeSecondary" />
          <h2 className=" font-badscript xl:text-[40px] pl-4 pr-4">
            Нашите вредности
          </h2>
          <hr className=" xl:w-32 w-16 border-2 border-OrangeSecondary" />
        </div>
        <div className=" xl:grid xl:grid-cols-3 flex-col items-center justify-around text-center pt-20">
          <div>
            <Image
              priority
              src="/images/images-static/img1.png"
              alt="Поврзување!"
              width={278}
              height={278}
              className="mx-auto"
            />
            <h2 className=" font-badscript xl:text-[40px] text-black pb-5">
              Поврзување!
            </h2>
            <p className="xl:text-xl text-black">
              Вистински луѓе. Автентична љубов.
            </p>
          </div>
          <div>
            <div>
              <Image
                priority
                src="/images/images-static/img2.png"
                alt="Поврзување!"
                width={278}
                height={278}
                className="mx-auto"
              />
              <h2 className=" font-badscript xl:text-[40px] text-black pb-5">
                Споделување на радост!
              </h2>
              <p className="xl:text-xl text-black">
                Уживајте во заедницата преку храна.
              </p>
            </div>
          </div>
          <div>
            <div>
              <Image
                priority
                src="/images/images-static/img3.png"
                alt="Поврзување!"
                width={278}
                height={278}
                className="mx-auto"
              />
              <h2 className=" font-badscript xl:text-[40px] text-black pb-5">
                Кулинарски можности!
              </h2>
              <p className="xl:text-xl text-black">
                Зајакнување на домашните готвачи.
              </p>
            </div>
          </div>
        </div>
        <div className="flex justify-center xl:pt-20 pt-7 ">
          <Link
            href="/"
            className=" xl:py-3 xl:px-2 py-2 bg-OrangePrimary text-white rounded-[20px] xl:w-72 w-48  font-medium text-sm xl:block text-center transition ease-in-out delay-150 hover:-translate-y-1 hover:scale-110 duration-300"
          >
            Дознај повеќе за нас
          </Link>
        </div>
      </section>
      <div className="flex items-center justify-center xl:py-10 relative">
        <hr className=" xl:w-32 w-16 border-2 border-OrangeSecondary" />
        <h2 className=" font-badscript xl:text-[40px] pl-4 pr-4">
          Запознајте ги нашите готвачи
        </h2>
        <hr className=" xl:w-32 w-16 border-2 border-OrangeSecondary" />
        <Image
          src="/images/background-images/domates2.svg"
          alt={"domates"}
          className=" absolute left-0 bottom-3 hidden lg:block"
          width={246}
          height={194}
        />
        <Image
          src="/images/background-images/piper2.svg"
          alt={"domates"}
          className=" absolute right-0 bottom-3 hidden lg:block"
          width={232}
          height={194}
        />
      </div>
      <div className="flex flex-wrap w-11/12 mx-auto">
        {userProfiles?.map((profile) => {
          return <CardCooks profile={profile} key={profile.id} />;
        })}
      </div>
      <div className="flex justify-center xl:py-20 py-7 relative">
        <Image
          src="/images/background-images/golema-levo.png"
          alt={"domates"}
          className=" absolute left-0  hidden lg:block"
          width={246}
          height={194}
        />
        <Image
          src="/images/background-images/golema-desno.png"
          alt={"domates"}
          className=" absolute right-0  hidden lg:block"
          width={246}
          height={194}
        />
        <Link
          href="/"
          className=" xl:py-3 xl:px-2 py-2 border-OrangeSecondary text-white rounded-[20px] xl:w-81 w-48  font-medium text-sm xl:block text-center transition ease-in-out delay-150 hover:-translate-y-1 hover:scale-110 duration-300"
        >
          Кон готвачи
        </Link>
      </div>
      <div className="text-center border-t-4 border-OrangeSecondary w-11/12 mx-auto border-b-4 xl:py-20">
        <div className="grid grid-cols-3 xl:gap-40 xl:content-center  gap-3 py-10  items-end">
          <div>
            <HeartIcon width={66} height={54} className="mx-auto" />
            <h3 className="  text-OrangePrimary xl:text-5xl font-bold py-3">
              10 900+
            </h3>
            <h3 className="font-badscript xl:text-2xl text-sm">
              задоволни клиенти
            </h3>
          </div>
          <div>
            <TeaIcon width={79} height={64} className="mx-auto" />
            <h3 className="  text-OrangePrimary xl:text-5xl font-bold py-3">
              13 765+
            </h3>
            <h3 className="font-badscript xl:text-2xl text-sm">
              подготвени јадења
            </h3>
          </div>
          <div>
            <HetIcon width={75} height={60} className="mx-auto" />
            <h3 className="  text-OrangePrimary xl:text-5xl font-bold py-3">
              864+
            </h3>
            <h3 className="font-badscript xl:text-2xl text-sm">
              среќни готвачи
            </h3>
          </div>
        </div>
      </div>

      <div className="grid xl:grid-cols-3 xl:gap-10 xl:content-center gap-10 xl:py-40 py-20 items-end w-11/12 mx-auto">
        <div className="shadow-2xl rounded p-4 ">
          <Image
            src="/images/images-static/gurman1.png"
            alt={"gurman"}
            width={262}
            height={262}
            className="mx-auto"
          />
          <div className="flex flex-col justify-center items-center">
            <h3 className="py-4 xl:text-lg">
              ,,Највкусната домашна храна што сум ја пробала! Едвај чекам да
              пробам уште многу вкусни јадења.’’
            </h3>
            <h3 className="py-4 xl:text-2xl">Мила Крстева, 32 години</h3>
          </div>
        </div>
        <div className="shadow-2xl rounded p-4 ">
          <Image
            src="/images/images-static/gurman2.png"
            alt={"gurman"}
            width={262}
            height={262}
            className="mx-auto"
          />
          <div className="flex flex-col justify-center items-center">
            <h3 className="py-4 xl:text-lg">
              ,,Јади домашно е најдобро нешто од мојот студенски живот во
              Скопје.Браво Јади домашно!!!’’
            </h3>
            <h3 className="py-4 xl:text-2xl">Лара Миланова, 22 години</h3>
          </div>
        </div>
        <div className="shadow-2xl rounded p-4">
          <Image
            src="/images/images-static/gurman3.png"
            alt={"gurman"}
            width={262}
            height={262}
            className="mx-auto"
          />
          <div className="flex flex-col justify-center items-center">
            <h3 className="py-4 xl:text-lg">
              ,Ни еден ресторан не може да го замени вкусот на домашно тавче
              гравче. Браво Јади домашно!!! ’’
            </h3>
            <h3 className="py-4 xl:text-2xl">Миле Венковски, 40 години</h3>
          </div>
        </div>
      </div>
      <div className="flex items-center justify-center">
        <div className="w-11/12 flex items-center justify-center">
          <hr className=" xl:w-[601px] w-20 border-2 border-OrangeSecondary" />
          <Image
            src="/images/images-static/домат1.png"
            alt={"gurman"}
            width={100}
            height={100}
            className="mx-auto"
          />
          <hr className=" xl:w-[601px] w-20 border-2 border-OrangeSecondary" />
        </div>
      </div>
      <div className="text-center mx-auto xl:py-28 py-10 relative">
        <h2 className=" xl:text-5xl font-normal">
          Стани дел од семејството
          <span className=" pl-5 xl:text-5xl font-normal  text-OrangePrimary">
            Јади Домашно
          </span>
        </h2>
        <Image
          src="/images/images-static/domates4.png"
          alt={"domates"}
          className=" absolute left-0 top-3  hidden lg:block"
          width={246}
          height={193}
        />
        <Image
          src="/images/images-static/desno-piperka.png"
          alt={"domates"}
          className=" absolute right-0 top-3  hidden lg:block"
          width={246}
          height={194}
        />
      </div>
      <div className="grid grid-cols-2 xl:gap-40 gap-20 text-center xl:py-10 w-11/12 mx-auto">
        <div className="border-b-4 border-OrangeSecondary">
          <Image
            src="/images/images-static/hrana-levo.png"
            alt={"gurman"}
            width={191}
            height={177}
            className="mx-auto"
          />
          <h3 className="xl:text-2xl py-10">Сакам да нарачувам храна</h3>
        </div>
        <div className="border-b-4 border-OrangeSecondary">
          <Image
            src="/images/images-static/gotvac-desno.png"
            alt={"gurman"}
            width={191}
            height={177}
            className="mx-auto"
          />
          <h3 className="xl:text-2xl py-10">Сакам да станам готвач</h3>
        </div>
      </div>
      <div className="relative">
        <div className=" w-11/12 grid xl:grid-cols-2 xl:gap-40 gap:10 mx-auto xl:pb-40 pt-10 pb-10">
          <div className="mx-auto xl:pb-0 pb-10">
            <div className="flex items-center justify-between py-4">
              <CarbonUserIcon width={50} height={50} />
              <h4 className="pl-5">
                Регистрирај се на платформата како клиент!
              </h4>
            </div>
            <div className="flex items-center justify-center py-4">
              <IconTwo width={60} height={60} />
              <h4 className="pl-5">
                Регистрирај се на платформата како клиент!
              </h4>
            </div>
            <div className="flex items-center justify-center py-4 ">
              <IconTree width={60} height={60} />
              <h4 className="pl-5">
                Регистрирај се на платформата како клиент!
              </h4>
            </div>
            <div className="flex items-center justify-center py-4">
              <IconFour width={60} height={60} />
              <h4 className="pl-5">
                Регистрирај се на платформата како клиент!
              </h4>
            </div>
            <div className="flex justify-center">
              <Link
                href="/signup"
                className="text-white  bg-OrangePrimary rounded-[20px] px-4 py-2"
              >
                Стани клиент
              </Link>
            </div>
          </div>
          <div className="mx-auto">
            <div className="flex items-center justify-center py-4">
              <CarbonUserIcon width={50} height={50} />
              <h4 className="pl-5">
                Регистрирај се на платформата како клиент!
              </h4>
            </div>
            <div className="flex items-center justify-center py-4">
              <IconTwo width={60} height={60} />
              <h4 className="pl-5">
                Регистрирај се на платформата како клиент!
              </h4>
            </div>
            <div className="flex items-center justify-center py-4">
              <IconTree width={60} height={60} />
              <h4 className="pl-5">
                Регистрирај се на платформата како клиент!
              </h4>
            </div>
            <div className="flex items-center justify-center py-4">
              <IconFour width={60} height={60} />
              <h4 className="pl-5">
                Регистрирај се на платформата како клиент!
              </h4>
            </div>
            <div className="flex justify-center">
              <Link
                href="/signup"
                className="text-white  bg-OrangePrimary rounded-[20px] px-4 py-2"
              >
                Стани готвач
              </Link>
            </div>
          </div>
          <Image
            src="/images/background-images/footer-levo.png"
            alt={"domates"}
            className=" absolute left-0 top-[270px] hidden lg:block -z-10"
            width={246}
            height={193}
          />
          <Image
            src="/images/background-images/footer-desno.png"
            alt={"domates"}
            className=" absolute right-0 top-[200px] hidden lg:block -z-10"
            width={246}
            height={194}
          />
        </div>
      </div>
    </>
  );
}

export const getServerSideProps: GetServerSideProps = async (ctx) => {
  const supabase = createServerSupabaseClient(ctx);
  const { data: profilesAllData } = await supabase.from("profiles").select("*");
  const { data: profilesData } = await supabase
    .from("profiles")
    .select("*")
    .limit(3);
  const profilesId = profilesData?.map((profile) => profile.id);

  const { data: recipesData } = await supabase
    .from("recipes")
    .select("*")
    .in("profiles_id", [...(profilesId as string[])]);

  const accumulatedRatingsPerProfile: any = {};

  const numberOfRecipes: any = {};

  recipesData?.forEach((recipe) => {
    if (accumulatedRatingsPerProfile[recipe.profiles_id]) {
      accumulatedRatingsPerProfile[recipe.profiles_id] = Math.floor(
        (recipe.raiting + accumulatedRatingsPerProfile[recipe.profiles_id]) /
          numberOfRecipes[recipe.profiles_id] +
          1
      );
      numberOfRecipes[recipe.profiles_id] =
        numberOfRecipes[recipe.profiles_id] + 1;
    } else {
      accumulatedRatingsPerProfile[recipe.profiles_id] = recipe.raiting;
      numberOfRecipes[recipe.profiles_id] = 1;
    }
  });

  const userProfiles = profilesData?.map((profile) => {
    return {
      ...profile,
      averageRating: accumulatedRatingsPerProfile[profile.id]
        ? accumulatedRatingsPerProfile[profile.id]
        : null,
    };
  });

  let searchResults = [];

  const { data, error } = await supabase
    .from("profiles")
    .select()
    .textSearch("user_adress", `'user_cusine' & 'full_name'`);

  if (error) {
    console.error(error);
  } else {
    searchResults = data;
  }

  return {
    props: {
      profilesData,
      recipesData,
      userProfiles,
      profilesAllData,
      searchResults,
    },
  };
};
